<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Deposit | OrbitSatellite</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }
    body {
      background: #0a0e17;
      color: #e0f7ff;
      min-height: 100vh;
      background-image: 
        radial-gradient(circle at 20% 30%, rgba(0, 168, 255, 0.1) 0%, transparent 40%),
        radial-gradient(circle at 80% 70%, rgba(100, 255, 218, 0.1) 0%, transparent 40%);
    }
    .orbit-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      opacity: 0.1;
      background: 
        radial-gradient(circle at 20% 30%, #00a8ff 0%, transparent 40%),
        radial-gradient(circle at 80% 70%, #64ffda 0%, transparent 40%);
    }
    .payment-header {
      background: linear-gradient(135deg, #0a0e17 0%, #1a283f 100%);
      color: #64ffda;
      padding: 20px 16px;
      text-align: center;
      font-size: 20px;
      font-weight: 600;
      position: relative;
      border-bottom: 1px solid rgba(100, 255, 218, 0.2);
    }
    .payment-header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, #00a8ff 0%, #64ffda 100%);
    }
    .back-btn {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: #64ffda;
      font-size: 20px;
      text-decoration: none;
    }
    .container {
      max-width: 500px;
      margin: 20px auto;
      padding: 0 16px;
    }
    .card {
      background: rgba(18, 25, 40, 0.9);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      margin-bottom: 20px;
      border: 1px solid rgba(100, 255, 218, 0.1);
      backdrop-filter: blur(10px);
    }
    .input-section {
      margin-bottom: 25px;
    }
    .input-section label {
      display: block;
      font-weight: 500;
      margin-bottom: 8px;
      color: #a0aec0;
      font-size: 14px;
    }
    .input-amount {
      width: 100%;
      padding: 16px;
      background: rgba(10, 14, 23, 0.6);
      border: 1px solid rgba(100, 255, 218, 0.2);
      border-radius: 12px;
      font-size: 18px;
      color: #e0f7ff;
      transition: all 0.3s;
    }
    .input-amount:focus {
      border-color: #00a8ff;
      outline: none;
      box-shadow: 0 0 0 2px rgba(0, 168, 255, 0.2);
    }
    .quick-amount {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin: 20px 0;
    }
    .amount-btn {
      background: rgba(10, 14, 23, 0.6);
      border: 1px solid rgba(100, 255, 218, 0.2);
      border-radius: 10px;
      padding: 12px;
      font-weight: 600;
      color: #e0f7ff;
      cursor: pointer;
      transition: all 0.3s;
    }
    .amount-btn:hover {
      background: rgba(0, 168, 255, 0.2);
      border-color: #00a8ff;
      transform: translateY(-2px);
    }
    .submit-btn {
      width: 100%;
      background: linear-gradient(135deg, #00a8ff 0%, #64ffda 100%);
      color: #0a0e17;
      border: none;
      border-radius: 12px;
      padding: 18px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0, 168, 255, 0.3);
    }
    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 168, 255, 0.4);
    }
    .submit-btn:active {
      transform: translateY(0);
    }
    .countdown-timer {
      background: linear-gradient(135deg, #00a8ff 0%, #64ffda 100%);
      color: #0a0e17;
      padding: 12px;
      border-radius: 12px;
      text-align: center;
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0, 168, 255, 0.3);
    }
    .amount-display {
      text-align: center;
      margin: 20px 0;
    }
    .amount-label {
      font-size: 14px;
      color: #a0aec0;
    }
    .amount-value {
      font-size: 32px;
      font-weight: 700;
      color: #64ffda;
      margin-top: 5px;
      text-shadow: 0 0 10px rgba(100, 255, 218, 0.5);
    }
    /* QRIS Frame yang lebih besar */
    .qris-container {
      width: 100%;
      margin: 20px 0;
      text-align: center;
    }
    .qris-frame {
      width: 320px; /* Diperbesar dari 280px */
      height: 320px; /* Diperbesar dari 280px */
      margin: 0 auto;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(100, 255, 218, 0.15);
    }
    .qris-image {
      max-width: 100%;
      max-height: 100%;
      border-radius: 8px;
    }
    .qris-instruction {
      font-size: 14px;
      color: #a0aec0;
      text-align: center;
      margin: 20px 0;
      line-height: 1.5;
    }
    .input-group {
      margin: 25px 0;
    }
    .input-group label {
      display: block;
      font-weight: 500;
      margin-bottom: 8px;
      color: #a0aec0;
      font-size: 14px;
    }
    .input-field {
      width: 100%;
      padding: 16px;
      background: rgba(10, 14, 23, 0.6);
      border: 1px solid rgba(100, 255, 218, 0.2);
      border-radius: 12px;
      font-size: 15px;
      color: #e0f7ff;
      transition: all 0.3s;
    }
    .input-field:focus {
      border-color: #00a8ff;
      outline: none;
      box-shadow: 0 0 0 2px rgba(0, 168, 255, 0.2);
    }
    .hidden {
      display: none;
    }
    .transaction-id {
      background: rgba(0, 168, 255, 0.1);
      padding: 12px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 20px;
      font-weight: bold;
      color: #00a8ff;
      border: 1px solid rgba(0, 168, 255, 0.2);
    }
    /* Success overlay */
    .success-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10, 14, 23, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    .success-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    .success-content {
      background: rgba(18, 25, 40, 0.95);
      padding: 40px;
      border-radius: 20px;
      text-align: center;
      width: 85%;
      max-width: 300px;
      border: 1px solid rgba(100, 255, 218, 0.2);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
    }
    .success-icon {
      color: #64ffda;
      font-size: 60px;
      margin-bottom: 20px;
      text-shadow: 0 0 20px rgba(100, 255, 218, 0.5);
    }
    /* Pending notification */
    .pending-notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 152, 0, 0.9);
      color: white;
      padding: 15px 25px;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
      z-index: 1001;
      display: flex;
      align-items: center;
      animation: slideDown 0.5s ease-out;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 193, 7, 0.3);
    }
    .pending-notification i {
      margin-right: 10px;
      font-size: 20px;
    }
    @keyframes slideDown {
      from { top: -50px; opacity: 0; }
      to { top: 20px; opacity: 1; }
    }
    .info-box {
      background: rgba(0, 168, 255, 0.1);
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      border-left: 3px solid #00a8ff;
      font-size: 14px;
      color: #a0aec0;
    }
    .info-box p {
      margin-bottom: 8px;
      display: flex;
      align-items: center;
    }
    .info-box p i {
      margin-right: 8px;
      color: #00a8ff;
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

<div class="orbit-bg"></div>

<!-- Deposit Form -->
<div id="depositPage">
  <div class="payment-header">
    <a href="dashboard.html" class="back-btn"><i class="fas fa-arrow-left"></i></a>
    <div>DEPOSIT SALDO</div>
  </div>
  <div class="container">
    <div class="card">
      <div class="input-section">
        <label for="amount">Masukkan Jumlah Deposit</label>
        <input type="text" id="amount" class="input-amount" placeholder="Contoh: 50.000">
      </div>
      <div class="quick-amount">
        <button class="amount-btn" onclick="setAmount(50000)">50K</button>
        <button class="amount-btn" onclick="setAmount(100000)">100K</button>
        <button class="amount-btn" onclick="setAmount(250000)">250K</button>
        <button class="amount-btn" onclick="setAmount(500000)">500K</button>
        <button class="amount-btn" onclick="setAmount(750000)">750K</button>
        <button class="amount-btn" onclick="setAmount(1000000)">1JT</button>
      </div>
      
      <!-- Input Metode Transfer -->
      <div class="input-group">
        <label for="transferMethod">Transfer Mengunakan?</label>
        <input type="text" id="transferMethod" class="input-field" placeholder="Contoh: DANA/BRI">
      </div>
      
      <button class="submit-btn" onclick="submitDeposit()">
        <i class="fas fa-paper-plane"></i> Ajukan Deposit
      </button>

      <div class="info-box">
        <p><i class="fas fa-info-circle"></i> Minimal deposit Rp50.000</p>
        <p><i class="fas fa-ban"></i>Lakukan deposit dengan benar sesuai panduan</p>
      </div>
    </div>
  </div>
</div>

<!-- QRIS Payment Page -->
<div id="qrisPage" class="hidden">
  <div class="payment-header">
    <a href="#" class="back-btn" onclick="backToDeposit()"><i class="fas fa-arrow-left"></i></a>
    <div>PEMBAYARAN QRIS</div>
  </div>
  <div class="container">
    <div class="card" style="border: 1px solid rgba(100, 255, 218, 0.05);">
      <div class="transaction-id" id="transactionIdDisplay">
        ID Transaksi: <span id="transactionIdValue"></span>
      </div>
      <div style="text-align:center;font-size:15px;color:#a0aec0;margin-bottom:15px;">
        Layanan 24 jam, Pastikan pembayaran Anda berhasil
      </div>
      <div class="countdown-timer" id="countdown">29:59</div>
      <div class="amount-display">
        <div class="amount-label">Jumlah pembayaran</div>
        <div class="amount-value" id="paymentAmount">IDR 50.000</div>
      </div>
    </div>
    
    <!-- QR Code Full Display (di luar card) -->
    <div class="qris-container">
      <div class="qris-frame">
        <img src="https://i.ibb.co.com/93twyQH3/QRIS-1.png" class="qris-image">
      </div>
      <div class="qris-instruction">
        Simpan kode QR<br>Unduh atau ambil tangkapan layar dan simpan kode QR
      </div>
    </div>
    
    <div class="card" style="border: 1px solid rgba(100, 255, 218, 0.05); margin-top: 20px;">
      <div class="input-group">
        <label for="senderName">Nama Pengirim</label>
        <input type="text" id="senderName" class="input-field" placeholder="contoh Budi/dana">
      </div>
      <!-- Kolom upload bukti transfer dihapus -->
      <button class="submit-btn" onclick="completePayment()">
        <i class="fas fa-check-circle"></i> Konfirmasi Deposit
      </button>
    </div>
  </div>
</div>

<!-- Success Overlay -->
<div class="success-overlay" id="successOverlay">
  <div class="success-content">
    <div class="success-icon"><i class="fas fa-check-circle"></i></div>
    <div style="font-size:18px;margin-bottom:15px;font-weight:bold;">Deposit Berhasil!</div>
    <div style="font-size:14px;color:#a0aec0;">Anda akan diarahkan ke dashboard...</div>
  </div>
</div>

<script>
// ========== GLOBAL STATE ==========
let isProcessing = false;
let countdownInterval;
let hasPendingDeposit = false;
let currentTransactionId = '';

// ========== DOM ELEMENTS ==========
const amountInput = document.getElementById('amount');

// ========== EVENT LISTENERS ==========
amountInput.addEventListener('input', formatAmount);

// Cek deposit pending saat halaman dimuat
document.addEventListener('DOMContentLoaded', checkPendingDeposits);

// ========== CORE FUNCTIONS ==========
function formatAmount() {
  let raw = this.value.replace(/\D/g, '');
  this.value = raw ? new Intl.NumberFormat('id-ID').format(raw) : '';
}

function setAmount(amount) {
  amountInput.value = new Intl.NumberFormat('id-ID').format(amount);
}

function generateTransactionId() {
  const timestamp = Date.now().toString();
  const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
  return 'TRX' + timestamp.slice(-9) + randomNum;
}

async function checkPendingDeposits() {
  try {
    const user = localStorage.getItem("nohp") || "guest";
    const response = await fetch(`https://lginvest-776cf-default-rtdb.firebaseio.com/deposit/${user}.json`);
    const data = await response.json();
    
    if (data) {
      const pendingDeposits = Object.values(data).filter(deposit => 
        deposit.status === "pending"
      );
      
      if (pendingDeposits.length > 0) {
        hasPendingDeposit = true;
        showPendingNotification();
      }
    }
  } catch (error) {
    console.error("Error checking pending deposits:", error);
  }
}

function showPendingNotification() {
  const notification = document.createElement('div');
  notification.className = 'pending-notification';
  notification.innerHTML = `
    <i class="fas fa-exclamation-circle"></i>
    Anda memiliki deposit yang masih diproses. Silakan tunggu hingga selesai.
  `;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 5000);
}

function submitDeposit() {
  if (hasPendingDeposit) {
    showPendingNotification();
    return;
  }
  
  const transferMethod = document.getElementById('transferMethod').value;
  if (!transferMethod) {
    alert('Harap isi metode transfer (contoh: DANA/BRI)');
    return;
  }
  
  let amount = parseInt(amountInput.value.replace(/\./g, '')) || 0;
  if (amount < 50000) {
    alert('Minimal deposit Rp 50.000');
    return;
  }
  
  // Generate transaction ID
  currentTransactionId = generateTransactionId();
  
  // Langsung menampilkan halaman QRIS tanpa loading
  document.getElementById('paymentAmount').textContent = 'IDR ' + amount.toLocaleString('id-ID');
  document.getElementById('transactionIdValue').textContent = currentTransactionId;
  switchPage('depositPage', 'qrisPage');
  startCountdown();
}

async function completePayment() {
  const name = document.getElementById('senderName').value;
  if (!name) {
    alert('Harap isi nama pengirim');
    return;
  }

  const transferMethod = document.getElementById('transferMethod').value;
  
  isProcessing = true;
  
  try {
    const amount = parseInt(document.getElementById('paymentAmount').textContent.replace(/\D/g, ''));
    await saveDeposit(amount, name, transferMethod);
    
    showSuccess();
    
    setTimeout(() => {
      window.location.href = "dashboard.html";
    }, 2000);
    
  } catch (error) {
    isProcessing = false;
    alert('Terjadi kesalahan: ' + error.message);
  }
}

function backToDeposit() {
  clearInterval(countdownInterval);
  switchPage('qrisPage', 'depositPage');
}

function startCountdown() {
  let m = 29, s = 59;
  clearInterval(countdownInterval);
  
  countdownInterval = setInterval(() => {
    s--; 
    if (s < 0) { 
      m--; 
      s = 59; 
    }
    if (m < 0) {
      clearInterval(countdownInterval);
      document.getElementById('countdown').textContent = "Waktu habis";
      return;
    }
    document.getElementById('countdown').textContent = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
  }, 1000);
}

// ========== UTILITY FUNCTIONS ==========
function showSuccess() {
  document.getElementById('successOverlay').classList.add('active');
}

function switchPage(hideId, showId) {
  document.getElementById(hideId).classList.add('hidden');
  document.getElementById(showId).classList.remove('hidden');
}

// ========== TELEGRAM NOTIFICATION ==========
async function sendTelegramNotification(message) {
  const botToken = '7734662682:AAEcXL2lzdocdtKK-FslT6joCR03XdpEO9g';
  const chatId = '6706406683';
  
  try {
    await fetch(`https://api.telegram.org/bot${botToken}/sendMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: chatId,
        text: message,
        parse_mode: 'HTML'
      })
    });
  } catch (error) {
    console.error('Error sending Telegram notification:', error);
    throw error;
  }
}
</script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyAuJSxpcFZ1QI-dEsEnx2qSqlb0wsvs6Mc",
    authDomain: "lginvest-776cf.firebaseapp.com",
    databaseURL: "https://lginvest-776cf-default-rtdb.firebaseio.com",
    projectId: "lginvest-776cf",
    storageBucket: "lginvest-776cf.firebasestorage.app",
    messagingSenderId: "831934282072",
    appId: "1:831934282072:web:6a8b7a5bcba5d4d1264d2d",
    measurementId: "G-265YF9DYCF"
  };

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

window.saveDeposit = async function(amount, name, transferMethod) {
  try {
    const user = localStorage.getItem("nohp") || "guest";
    const depositRef = ref(db, "deposit/" + user);
    const newData = push(depositRef);

    const formattedAmount = new Intl.NumberFormat('id-ID', {
      style: 'currency',
      currency: 'IDR'
    }).format(amount);

    const time = new Date().toLocaleString('id-ID', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    });

    const telegramMessage = `üì• DEPOSIT BARU\n` +
      `üë§ User: ${user}\n` +
      `üí∞ Jumlah: ${formattedAmount}\n` +
      `üè¶ Metode: ${transferMethod}\n` +
      `üë® Pengirim: ${name}\n` +
      `üîπ ID Transaksi: ${currentTransactionId}\n` +
      `‚è∞ Waktu: ${time}\n\n` +
      `Status: Pending Verifikasi`;

    await set(newData, {
      jumlah: amount,
      pengirim: name,
      metode: transferMethod,
      status: "pending",
      tanggal: new Date().toLocaleString(),
      id_transaksi: currentTransactionId
    });

    await sendTelegramNotification(telegramMessage);

    return true;

  } catch (err) {
    console.error("Error saving deposit:", err);
    throw new Error("Gagal menyimpan data deposit");
  }
};
</script>

</body>
</html>